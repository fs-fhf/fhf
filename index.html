<!DOCTYPE html>
<html>
	<head>
		<meta charset='utf-8' />
		<title>F+S find a home!</title>
		
		<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
		<meta http-equiv="Pragma" content="no-cache" />
		<meta http-equiv="Expires" content="0" />
		
		<script src='jquery-3.4.1.min.js'></script>
		
		<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />		
		<script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.js'></script>
		<script src='geo.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.53.1/mapbox-gl.css' rel='stylesheet' />
		<style>
			body { margin:0; padding:0; }
			#map { position:absolute; top:0; bottom:0; width:100%; }
		</style>
		
		<link rel="icon" href="home.png">
		<link rel="shortcut icon" href="home.png">
		
		<script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/6.3.3/firebase-firestore.js"></script>

		<link rel="manifest" href="manifest.json">		
	</head>
	<body>
		 
		<div id='map'></div>
		<script>			
			firebase.initializeApp({
				apiKey: 'AIzaSyBeSNUtcMLie-J7-WNrReZyf6UiSkOUF8E',
				projectId: 'fs-find-a-home'
			});

			var db = firebase.firestore();
			
			function hide(url) {
				db.collection('prop-visibility').add({
					url: url,
					hide: 1
				})
				.then(function(docRef) {
					location.reload();
				});				
			}
			
			db.collection('prop-visibility').get().then((querySnapshot) => {				
				querySnapshot.forEach((doc) => {
					var d = doc.data();
					
					var filter = false;
					for (var i in geojson.features) {
						if (geojson.features[i].properties.url == d.url) {
							geojson.features.splice(i, 1);
							//console.log('filtered')
							break;
						}
					}
				});
				
				var url = new URL(window.location);
				var f = url.searchParams.get("f");
				//console.log( f );
				if ( f != null ) {
					for (var i=geojson.features.length-1; i>0; i--) {
						if ( geojson.features[i].properties[f] != true ) {
							geojson.features.splice(i, 1);
							console.log('filtered')
						}
					}
				}
									
					mapboxgl.accessToken = 'pk.eyJ1IjoibWFyY2VsbG9zYXZhcmVzZSIsImEiOiJjamthMHNnY2UwMmpnM3hwYW9xOTdtbHpqIn0.uN2ukoNn6XH5yCzIPNOa5Q';
								
					var popup = new mapboxgl.Popup({
		//				closeButton: false
					});

					var map = new mapboxgl.Map({
						container: 'map',
						style: 'mapbox://styles/ffabbri661/cjwi0sqka0gp41cqte4j4c6bg',
						zoom: 12,
						center: [9.1815, 45.4773],				
						pitch: 60
					});
					 
					map.on('load', function () {				
						map.addLayer({
							'id': '3d-buildings',
							'source': 'composite',
							'source-layer': 'building',
							'filter': ['==', 'extrude', 'true'],
							'type': 'fill-extrusion',
							'minzoom': 15,
							'paint': {
								'fill-extrusion-color': '#aaa',
								'fill-extrusion-height': [
									"interpolate", ["linear"], ["zoom"],
									15, 0,
									15.05, ["get", "height"]
									],
									'fill-extrusion-base': [
									"interpolate", ["linear"], ["zoom"],
									15, 0,
									15.05, ["get", "min_height"]
								],
								'fill-extrusion-opacity': .6
							}
						});
						
						map.addSource('fhf', {
							"type": "geojson",
							"data": geojson
						});

						map.addLayer({
							'id': 'properties',
							'type': 'circle',
							'source': 'fhf',
							'paint': {
								'circle-radius': {
									'base': 5,
									'stops': [[12, 5], [14, 8], [22, 180]]
								},
								'circle-color': [
									'interpolate',
									['linear'],
									['get', 'prmq'],
									1000, 'green',
									2500, 'yellow',
									5000, 'red'
								],
								'circle-opacity': [
									'match',
									['get', 'hide'],
									1, 0,
									1
								],
							}
						});
						
						map.addLayer({
							'id': 'properties-txt',
							'type': 'symbol',
							'source': 'fhf',
							'layout': {
								'text-field': ['get', 'isNew'],
								'text-font': ['Open Sans Bold', 'Arial Unicode MS Bold'],
								'text-size': 10,
								'text-offset': [1.5, 0]
							},
							'paint': {
								'text-color': 'rgb(0,0,0)',
							}
						});
					});
					
					map.on('click', 'properties', function (e) {
						var feature = e.features[0];
						
						/*
						var poptxt = '';
						for (var p in feature.properties) {
							if (p == 'url')
								poptxt += p + ': <a href="#" onclick="window.open(\'' + feature.properties[p] + '\', \'_blank\').focus();">' + feature.properties[p] + '</a><br/>';
							else if (p.match(/prmq_d/))
								poptxt += p + ': ' + (feature.properties[p]*100).toFixed(2) + '%<br/>';
							else if (p.match(/prmq/))
								poptxt += p + ': ' + Math.round(feature.properties[p]) + '<br/>';
							else if (p.match(/isNew/) || p.match(/lastSeen/) || p.match(/hide/) || p.charAt(0) == '_')
								poptxt += ''
							else
								poptxt = poptxt + p + ': ' + feature.properties[p] + '<br/>';
						}
						*/

						var poptxt = '';
						poptxt += feature.properties['su'] + ' mq | ' + feature.properties['loc'] + ' locali | ' + ' piano ' + feature.properties['level'] + '/' + feature.properties['levelMax'] + '<br/>';
						poptxt += Math.round(feature.properties['pr']/1000) + ' k€ | ' + Math.round(feature.properties['prmq']) + ' €/mq (' + (feature.properties['prmq_d100_r'] > 0 ? '+' : '') + (feature.properties['prmq_d100_r']*100).toFixed(1) + '% 100mt / ' + (feature.properties['prmq_d500_r'] > 0 ? '+' : '') + (feature.properties['prmq_d500_r']*100).toFixed(1) + '% 500mt' + ') | ' + feature.properties['daysOnSale'] + ' days' + '<br/>';
						poptxt += feature.properties['dist'] + '<br/>';

						poptxt += '<br/><a href="#" onclick="window.open(\'' + feature.properties['url'] + '\', \'_blank\').focus();">[Open]</a>';
						if (feature.properties.hide != 1) {
							poptxt += '  <a href="#" onclick="hide(\'' + feature.properties.url + '\');">[Hide]</a>';
						}
						
						popup.setLngLat(e.lngLat)
							.setHTML(poptxt)
							.addTo(map);
					});
					
					map.on('mouseenter', 'properties', function(e) {
						map.getCanvas().style.cursor = 'pointer';
					});
		 
					map.on('mouseleave', 'properties', function() {
						map.getCanvas().style.cursor = '';
					});				
				
			});
			
			tsMax = null;
			for (var i in geojson.features) {
				if (tsMax == null || new Date(geojson.features[i].properties._lastRun.$date) > tsMax)
					tsMax = new Date(geojson.features[i].properties._lastRun.$date);
			}
			
			setInterval(function () {
				$('.mapboxgl-ctrl-bottom-left').html(tsMax.toISOString().substr(0,16).replace('T', ' '));
				$('.mapboxgl-ctrl-bottom-right').hide();
			}, 1000);
		</script>
	 
	</body>
</html>
